<html>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="jquery.min.js"></script>
    <script src="socket.io.js"></script>
    <script>
        $(function () {

            let socket = io(location.host);
            console.log("socket", socket);
            socket.emit("drive", "msg");
            let isDriving = false;
            let lastSpeed = 0;
            let lastDirection = 0;

            let startPoint = {
                x: 0,
                y: 0
            };


            var $indikator = $(".pointer-indikator");

            $("[data-control-input]")
                .on("pointerdown mousedown touchstart", function (e) {
                 //   console.log("start",e)
                    console.log("start");
                    isDriving = true;
                    $indikator.fadeIn().css({top:e.pageY, left: e.pageX});
                    //socket.emit("drive", "msg");
                    startPoint.x = e.screenX;
                    startPoint.y = e.screenY;

                })
                .on("pointermove mousemove touchmove", function (e) {
                    if (!isDriving) return;

                    let speed = startPoint.y - e.screenY;
                    let direction = e.screenX - startPoint.x;
                    if (speed > 255) speed = 255;
                    if (speed <  -255) speed = -255;

                    if (direction > 255) direction = 255;
                    if (direction <  -255) direction = -255;

                    let speedDelta = (speed - lastSpeed);
                    let directionDelta = (direction - lastDirection);

                    if (Math.abs(speedDelta) > 15 || Math.abs(directionDelta) ) {

                        let motorSpeeds = getMotorSpeeds(speed, direction);
                        console.log("moveSpeeds",motorSpeeds,"direction",direction,"speed",speed);

                        socket.emit("drive", motorSpeeds);
                        lastSpeed = speed;
                        lastDirection = direction;
                    }
                })
                .on("pointerup mouseup touchend", function () {
                    stop();

                });

                $(window).on("blur", function () {
                    stop();
                });

                function stop(){
                    isDriving = false;
                    lastDirection = 0;
                    lastSpeed = 0;
                    $indikator.fadeOut();
                    socket.emit("drive", {motor1:0, motor2:0});
                }

                function getMotorSpeeds (speed, direction) {
                    let motor1 = 0;
                    let motor2 = 0;

                    // DÃ¤mpfung
                    let directionDaempfung = 20;
                    if (Math.abs(direction) < directionDaempfung) { direction = 0; }
                    if (direction > directionDaempfung) { direction = direction - directionDaempfung;}
                    if (direction < -directionDaempfung) { direction = direction + directionDaempfung;}


                    if (direction > 0) {
                        motor1 = speed;
                        motor2 = speed - direction;
                        if (motor1 < -speed) motor1 = -speed;
                        if (motor1 > speed) motor1 = speed;

                        if (motor2 < -speed) motor2 = -speed;
                        if (motor2 > speed) motor2 = speed;
                    }
                    if (direction < 0) {
                        motor1 = speed + direction;
                        motor2 = speed;
                        if (motor2 < -speed) motor2 = -speed;
                        if (motor2 > speed) motor2 = speed;

                        if (motor1 < -speed) motor1 = -speed;
                        if (motor1 > speed) motor1 = speed;
                    }

                    if (direction == 0) {
                        motor1 = speed;
                        motor2 = speed;
                    }

                    return {motor1: motor1, motor2: motor2}
                }
    
        });
    </script>
    <link rel="stylesheet" href="area.css" />


    <div class="area-control" data-control-input>
        <div class="area-text">
            <h1> Fernbedienung</h1>
        </div>
    </div>

    <div class="pointer-indikator"></div>
</html>
